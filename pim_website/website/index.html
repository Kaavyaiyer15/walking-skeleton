<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notes App</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #0f0f0f;
        background-image: radial-gradient(
            circle at 25% 25%,
            #1a1a1a 0%,
            transparent 50%
          ),
          radial-gradient(circle at 75% 75%, #1a1a1a 0%, transparent 50%),
          radial-gradient(circle at 50% 50%, #111111 0%, transparent 50%);
        min-height: 100vh;
        color: #e5e5e5;
      }

      .container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(10px);
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header h1 {
        color: #ffffff;
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .auth-section {
        width: 100%;
        max-width: 450px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .auth-container {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 100%;
      }

      .auth-toggle {
        display: flex;
        background: rgba(40, 40, 40, 0.5);
        border-radius: 12px;
        padding: 4px;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .toggle-btn {
        flex: 1;
        background: transparent;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
        font-weight: 600;
        color: #9ca3af;
        font-size: 1rem;
      }

      .toggle-btn.active {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 8px 15px rgba(99, 102, 241, 0.4);
      }

      .toggle-btn:hover:not(.active) {
        background: rgba(99, 102, 241, 0.2);
        transform: translateY(-1px);
        color: #d1d5db;
      }

      .auth-form {
        display: none;
      }

      .auth-form.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .auth-form h2 {
        text-align: center;
        margin-bottom: 2rem;
        color: #ffffff;
        font-size: 1.8rem;
        font-weight: 700;
      }

      .auth-form input {
        width: 100%;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: rgba(40, 40, 40, 0.8);
        color: #ffffff;
      }

      .auth-form input::placeholder {
        color: #9ca3af;
      }

      .auth-form input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        transform: translateY(-2px);
        background: rgba(50, 50, 50, 0.9);
      }

      .btn {
        width: 100%;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info span {
        color: #e5e5e5;
        font-weight: 600;
        background: rgba(40, 40, 40, 0.8);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-logout {
        width: auto;
        padding: 0.5rem 1.5rem;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        font-size: 0.9rem;
        text-transform: none;
        letter-spacing: normal;
      }

      .btn-logout:hover {
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
      }

      .hidden {
        display: none !important;
      }

      /* Notes Section Styling */
      .notes-section {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        display: none;
      }

      .notes-section.active {
        display: block;
      }

      .notes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        background: rgba(30, 30, 30, 0.95);
        padding: 1.5rem 2rem;
        border-radius: 20px;
        backdrop-filter: blur(15px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .notes-header h2 {
        color: #ffffff;
        font-size: 1.8rem;
        font-weight: 700;
      }

      .btn-add {
        width: auto;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #10b981, #059669);
        font-size: 1rem;
        text-transform: none;
        letter-spacing: normal;
      }

      .btn-add:hover {
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
      }

      .note-form {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
      }

      .note-form.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      .note-form h3 {
        color: #ffffff;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
      }

      .note-form input,
      .note-form textarea {
        width: 100%;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        font-size: 1rem;
        background: rgba(40, 40, 40, 0.8);
        color: #ffffff;
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .note-form input::placeholder,
      .note-form textarea::placeholder {
        color: #9ca3af;
      }

      .note-form input:focus,
      .note-form textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        background: rgba(50, 50, 50, 0.9);
      }

      .note-form textarea {
        min-height: 150px;
        resize: vertical;
      }

      .form-buttons {
        display: flex;
        gap: 1rem;
      }

      .btn-save {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        text-transform: none;
        letter-spacing: normal;
      }

      .btn-cancel {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        color: white;
        text-transform: none;
        letter-spacing: normal;
      }

      #notesContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        min-height: 200px;
      }

      .note-card {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .note-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
      }

      .note-card h4 {
        color: #ffffff;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        word-break: break-word;
      }

      .note-card p {
        color: #e5e5e5;
        line-height: 1.6;
        margin-bottom: 1rem;
        word-break: break-word;
      }

      .note-card .note-meta {
        color: #9ca3af;
        font-size: 0.85rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 0.75rem;
      }

      .loading {
        text-align: center;
        color: #e5e5e5;
        font-size: 1.2rem;
        padding: 2rem;
        background: rgba(30, 30, 30, 0.8);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        grid-column: 1 / -1;
      }

      .empty-state {
        text-align: center;
        color: #9ca3af;
        font-size: 1.1rem;
        padding: 3rem 2rem;
        background: rgba(30, 30, 30, 0.8);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        grid-column: 1 / -1;
      }

      .empty-state h3 {
        color: #ffffff;
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .no-notes {
        text-align: center;
        color: #9ca3af;
        font-size: 1.1rem;
        padding: 3rem 2rem;
        background: rgba(30, 30, 30, 0.8);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        grid-column: 1 / -1;
      }

      /* Message styling */
      .message {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 600;
        background: rgba(40, 40, 40, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e5e5e5;
        display: none;
      }

      .message.show {
        display: block;
      }

      .message.success {
        background: rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.3);
        color: #10b981;
      }

      .message.error {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.3);
        color: #ef4444;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .header {
          padding: 1rem;
          flex-direction: column;
          gap: 1rem;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .auth-container {
          padding: 2rem 1.5rem;
          margin: 1rem;
        }

        .content {
          padding: 1rem;
        }

        .notes-header {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .form-buttons {
          flex-direction: column;
        }

        .user-info {
          flex-direction: column;
          gap: 0.5rem;
          text-align: center;
        }

        #notesContainer {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Notes App</h1>
        <div class="user-info hidden" id="userInfo">
          <span id="userEmail"></span>
          <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="content">
        <!-- Authentication -->
        <div class="auth-section" id="authSection">
          <div class="auth-container">
            <!-- Toggle Buttons -->
            <div class="auth-toggle">
              <button
                class="toggle-btn active"
                id="loginToggle"
                onclick="showLogin()"
              >
                Login
              </button>
              <button
                class="toggle-btn"
                id="signupToggle"
                onclick="showRegister()"
              >
                Sign Up
              </button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active">
              <h2>Welcome Back</h2>
              <div id="loginMessage" class="message"></div>
              <input
                type="email"
                id="loginEmail"
                placeholder="Email"
                required
              />
              <input
                type="password"
                id="loginPassword"
                placeholder="Password"
                required
              />
              <button class="btn" type="submit">Login</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form">
              <h2>Create Account</h2>
              <div id="registerMessage" class="message"></div>
              <input
                type="email"
                id="registerEmail"
                placeholder="Email"
                required
              />
              <input
                type="password"
                id="registerPassword"
                placeholder="Password (min 6 characters)"
                required
              />
              <button class="btn" type="submit">Create Account</button>
            </form>
          </div>
        </div>

        <!-- Notes -->
        <div class="notes-section" id="notesSection">
          <div class="notes-header">
            <h2>My Notes</h2>
            <button class="btn btn-add" onclick="showNoteForm()">
              Add Note
            </button>
          </div>

          <!-- Note Form -->
          <div class="note-form" id="noteForm">
            <h3>Add New Note</h3>
            <input
              type="text"
              id="noteTitle"
              placeholder="Note title..."
              maxlength="100"
              required
            />
            <textarea
              id="noteBody"
              placeholder="Write your note here..."
              required
            ></textarea>
            <div class="form-buttons">
              <button class="btn btn-save" onclick="saveNote()">
                Save Note
              </button>
              <button class="btn btn-cancel" onclick="cancelNoteForm()">
                Cancel
              </button>
            </div>
          </div>

          <div id="notesContainer">
            <!-- Notes will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let token = null;

      // Utility functions
      function showMessage(elementId, message, isSuccess = true) {
        const msgElement = document.getElementById(elementId);
        if (msgElement) {
          msgElement.textContent = message;
          msgElement.className = `message show ${
            isSuccess ? "success" : "error"
          }`;

          // Auto-hide success messages after 3 seconds
          if (isSuccess) {
            setTimeout(() => {
              msgElement.className = "message";
              msgElement.textContent = "";
            }, 3000);
          }
        }
      }

      function clearMessage(elementId) {
        const msgElement = document.getElementById(elementId);
        if (msgElement) {
          msgElement.textContent = "";
          msgElement.className = "message";
        }
      }

      function clearForm(formId) {
        const form = document.getElementById(formId);
        if (form) {
          form.reset();
        }
      }

      function formatDate(dateString) {
        try {
          return new Date(dateString).toLocaleString();
        } catch (error) {
          return dateString;
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Validate email format
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Toggle between login and signup forms
      function showLogin() {
        document.getElementById("loginForm").classList.add("active");
        document.getElementById("registerForm").classList.remove("active");
        document.getElementById("loginToggle").classList.add("active");
        document.getElementById("signupToggle").classList.remove("active");
        clearMessage("registerMessage");
        clearMessage("loginMessage");
      }

      function showRegister() {
        document.getElementById("registerForm").classList.add("active");
        document.getElementById("loginForm").classList.remove("active");
        document.getElementById("signupToggle").classList.add("active");
        document.getElementById("loginToggle").classList.remove("active");
        clearMessage("registerMessage");
        clearMessage("loginMessage");
      }

      // Register user
      async function registerUser(event) {
        event.preventDefault();

        const emailInput = document.getElementById("registerEmail");
        const passwordInput = document.getElementById("registerPassword");

        if (!emailInput || !passwordInput) {
          console.error("Registration form elements not found");
          return;
        }

        const email = emailInput.value.trim();
        const password = passwordInput.value;

        // Clear previous messages
        clearMessage("registerMessage");

        // Validation
        if (!email || !password) {
          showMessage("registerMessage", "Please fill in all fields", false);
          return;
        }

        if (!isValidEmail(email)) {
          showMessage(
            "registerMessage",
            "Please enter a valid email address",
            false
          );
          return;
        }

        if (password.length < 6) {
          showMessage(
            "registerMessage",
            "Password must be at least 6 characters long",
            false
          );
          return;
        }

        // Disable submit button during request
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Registering...";
        }

        try {
          const res = await fetch("/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await res.json();

          if (res.ok) {
            showMessage(
              "registerMessage",
              "Registration successful! You can now login."
            );
            clearForm("registerForm");

            // Switch to login form after successful registration
            setTimeout(() => {
              showLogin();
              const loginEmailInput = document.getElementById("loginEmail");
              if (loginEmailInput) {
                loginEmailInput.value = email;
                loginEmailInput.focus();
              }
            }, 1500);
          } else {
            showMessage(
              "registerMessage",
              data.detail || "Registration failed",
              false
            );
          }
        } catch (error) {
          showMessage(
            "registerMessage",
            "Network error. Please check your connection.",
            false
          );
          console.error("Registration error:", error);
        } finally {
          // Re-enable submit button
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Create Account";
          }
        }
      }

      // Login user
      async function loginUser(event) {
        event.preventDefault();

        const emailInput = document.getElementById("loginEmail");
        const passwordInput = document.getElementById("loginPassword");

        if (!emailInput || !passwordInput) {
          console.error("Login form elements not found");
          return;
        }

        const email = emailInput.value.trim();
        const password = passwordInput.value;

        // Clear previous messages
        clearMessage("loginMessage");

        // Validation
        if (!email || !password) {
          showMessage("loginMessage", "Please fill in all fields", false);
          return;
        }

        if (!isValidEmail(email)) {
          showMessage(
            "loginMessage",
            "Please enter a valid email address",
            false
          );
          return;
        }

        // Disable submit button during request
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Logging in...";
        }

        try {
          const res = await fetch("/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await res.json();

          if (res.ok && data.token) {
            token = data.token;

            // Update UI
            const userEmailElement = document.getElementById("userEmail");
            if (userEmailElement) {
              userEmailElement.textContent = email;
            }

            showNotesSection();
            clearForm("loginForm");

            // Load notes
            await loadNotes();

            showMessage("loginMessage", "Login successful!", true);
          } else {
            showMessage("loginMessage", data.detail || "Login failed", false);
          }
        } catch (error) {
          showMessage(
            "loginMessage",
            "Network error. Please check your connection.",
            false
          );
          console.error("Login error:", error);
        } finally {
          // Re-enable submit button
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Login";
          }
        }
      }

      // Show notes section after successful login
      function showNotesSection() {
        const authSection = document.getElementById("authSection");
        const notesSection = document.getElementById("notesSection");
        const userInfo = document.getElementById("userInfo");

        if (authSection) authSection.style.display = "none";
        if (notesSection) notesSection.classList.add("active");
        if (userInfo) userInfo.classList.remove("hidden");
      }

      // Logout user
      async function logout() {
        // Call logout endpoint if token exists
        if (token) {
          try {
            await fetch("/logout", {
              method: "POST",
              headers: {
                Authorization: token,
                Accept: "application/json",
              },
            });
          } catch (error) {
            console.warn("Logout request failed:", error);
          }
        }

        // Clear local state
        token = null;

        // Reset UI
        const authSection = document.getElementById("authSection");
        const notesSection = document.getElementById("notesSection");
        const userInfo = document.getElementById("userInfo");

        if (authSection) authSection.style.display = "flex";
        if (notesSection) notesSection.classList.remove("active");
        if (userInfo) userInfo.classList.add("hidden");

        // Clear forms and messages
        clearForm("loginForm");
        clearForm("registerForm");
        clearMessage("loginMessage");
        clearMessage("registerMessage");

        // Clear notes container
        const notesContainer = document.getElementById("notesContainer");
        if (notesContainer) {
          notesContainer.innerHTML = "";
        }

        // Hide note form
        cancelNoteForm();

        console.log("User logged out successfully");
      }

      // Load and display notes
      async function loadNotes() {
        if (!token) {
          console.warn("No token available for loading notes");
          return;
        }

        const container = document.getElementById("notesContainer");
        if (!container) {
          console.error("Notes container not found");
          return;
        }

        container.innerHTML = '<div class="loading">Loading notes...</div>';

        try {
          const res = await fetch("/notes", {
            method: "GET",
            headers: {
              Authorization: token,
              Accept: "application/json",
            },
          });

          if (res.ok) {
            const data = await res.json();
            const notes = data.notes || [];

            container.innerHTML = "";

            if (notes.length === 0) {
              container.innerHTML = `
                <div class="no-notes">
                  <h3>No notes yet</h3>
                  <p>Click "Add Note" to create your first note!</p>
                </div>
              `;
            } else {
              // Notes should already be sorted by the backend
              notes.forEach((note) => {
                const noteDiv = document.createElement("div");
                noteDiv.className = "note-card";
                noteDiv.innerHTML = `
                  <h4>${escapeHtml(note.title)}</h4>
                  <p>${escapeHtml(note.body) || "<em>No content</em>"}</p>
                  <div class="note-meta">
                    Created: ${formatDate(note.created_time)}
                    ${
                      note.updated_time !== note.created_time
                        ? `<br>Updated: ${formatDate(note.updated_time)}`
                        : ""
                    }
                  </div>
                `;
                container.appendChild(noteDiv);
              });
            }
          } else if (res.status === 401) {
            // Token expired or invalid
            console.warn("Authentication failed, logging out user");
            logout();
            showMessage(
              "loginMessage",
              "Session expired. Please login again.",
              false
            );
          } else {
            const errorData = await res.json().catch(() => ({}));
            container.innerHTML = `<div class="loading">Failed to load notes: ${
              errorData.detail || "Unknown error"
            }</div>`;
          }
        } catch (error) {
          container.innerHTML =
            '<div class="loading">Network error. Please check your connection.</div>';
          console.error("Load notes error:", error);
        }
      }

      // Show note creation form
      function showNoteForm() {
        const noteForm = document.getElementById("noteForm");
        const titleInput = document.getElementById("noteTitle");

        if (noteForm) {
          noteForm.classList.add("active");
        }

        if (titleInput) {
          titleInput.focus();
        }
      }

      // Cancel note creation
      function cancelNoteForm() {
        const titleInput = document.getElementById("noteTitle");
        const bodyInput = document.getElementById("noteBody");
        const noteForm = document.getElementById("noteForm");

        if (titleInput) titleInput.value = "";
        if (bodyInput) bodyInput.value = "";
        if (noteForm) noteForm.classList.remove("active");
      }

      // Save new note
      async function saveNote() {
        const titleInput = document.getElementById("noteTitle");
        const bodyInput = document.getElementById("noteBody");

        if (!titleInput || !bodyInput) {
          console.error("Note form elements not found");
          return;
        }

        const title = titleInput.value.trim();
        const body = bodyInput.value.trim();

        if (!title) {
          alert("Please enter a title for your note");
          titleInput.focus();
          return;
        }

        if (!token) {
          alert("Please login first");
          logout();
          return;
        }

        // Disable save button during request
        const saveBtn = document.querySelector('button[onclick="saveNote()"]');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.textContent = "Saving...";
        }

        try {
          const res = await fetch("/notes", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
              Accept: "application/json",
            },
            body: JSON.stringify({ title, body }),
          });

          if (res.ok) {
            const data = await res.json();
            console.log("Note saved successfully:", data);

            cancelNoteForm();
            await loadNotes();

            // Show success message briefly
            const container = document.getElementById("notesContainer");
            if (container && container.children.length > 0) {
              const successMsg = document.createElement("div");
              successMsg.style.cssText =
                "color: #10b981; font-weight: bold; margin-bottom: 10px; text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.2); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);";
              successMsg.textContent = "Note saved successfully!";
              container.insertBefore(successMsg, container.firstChild);

              setTimeout(() => {
                if (successMsg.parentNode) {
                  successMsg.parentNode.removeChild(successMsg);
                }
              }, 2000);
            }
          } else if (res.status === 401) {
            logout();
            alert("Session expired. Please login again.");
          } else {
            const err = await res.json().catch(() => ({}));
            alert(`Could not save note: ${err.detail || "Unknown error"}`);
          }
        } catch (error) {
          alert("Network error. Please try again.");
          console.error("Save note error:", error);
        } finally {
          // Re-enable save button
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = "Save Note";
          }
        }
      }

      // Initialize app when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing app...");

        // Attach event listeners
        const registerForm = document.getElementById("registerForm");
        const loginForm = document.getElementById("loginForm");

        if (registerForm) {
          registerForm.addEventListener("submit", registerUser);
        } else {
          console.warn("Register form not found");
        }

        if (loginForm) {
          loginForm.addEventListener("submit", loginUser);
        } else {
          console.warn("Login form not found");
        }

        // Add keyboard shortcuts
        document.addEventListener("keydown", function (event) {
          // Escape key to cancel note form
          if (event.key === "Escape") {
            const noteForm = document.getElementById("noteForm");
            if (noteForm && noteForm.classList.contains("active")) {
              cancelNoteForm();
            }
          }

          // Ctrl+N to create new note (when logged in)
          if (event.ctrlKey && event.key === "n" && token) {
            event.preventDefault();
            showNoteForm();
          }
        });

        // Auto-focus first input on page load
        const firstInput = document.querySelector('input[type="email"]');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 100);
        }

        console.log("App initialization complete");
      });

      // Handle page visibility changes (optional feature)
      document.addEventListener("visibilitychange", function () {
        if (!document.hidden && token) {
          // Refresh notes when page becomes visible again
          loadNotes();
        }
      });
    </script>
  </body>
</html>
